## Введение

**Разведка** - процесс сбора любой информации о цели.

**Инфраструктура** - совокупность аппаратных, программных и сетевых средств для поддержания процессов и безопасности информации цели.

**Способы сбора информации:**
- **Активный** - сбор информации напрямую, путем контакта с DNS сервисами цели.
  Примеры активных методов сбора информации:
	- Сканирование портов
	- Энумерация и предугадывание доменных имен
	- Посещение и анализ сайтов
- **Пассивный** - сбор информации косвенно, путем работы с публичными сервисами, тем самым маскируя деятельность.
  Примеры пассивных методов сбора информации:
	- Поиск на онлайн ресурсах
	- Анализ баз данных
	- Анализ открытых источников информации

**Собираем:**
- Доменные имена, поддомены и тд.
- IP-адреса и сервисы
- Учетные записи
- Публичные email адреса

**Инструменты для сбора информации:**
Простейшие консольные утилиты:
- *host* - выполняет DNS-запросы для получения информации о доменных именах и IP-адресах
- *ping* - проверяет можно ли установить соединение с целью. Шлет эхо-запросы с помощью протокола ICMP, проверяя соединение и скорость передачи данных.
- *traceroute* - в дополнение к *ping* дает сведения о полном маршруте данных до цели.
- *nslookup* 

Более мощные инструменты:
- Сайт [*dnsdumpster.com*](https://dnsdumpster.com/)
  Выполняет мощную разведку с большим количеством информации по цели.
- Консольная утилита *amass*
  Выполняет поиск субдоменов цели, а также строит графы связей инфраструктуры цели.
- *nmap + FUZZ whois*
- *DMitry*
- *Maltego*

**Цели по исполнению этапа сбора информации:**
1. Обнаружение доменных имен, принадлежащих организации
2. Обнаружение “живых” хостов в сети и составления списка их IP-адресов
3. Определение актуального статуса сетевых портов узлов из списка
4. Определение типа и версии операционной системы на исследованных машинах
5. Определение версий ПО или служб, которые находятся на сетевых портах
6. Сбор информации об используемых технологиях на веб-сайте

**Важные ссылки:**
- *[OSINT Framework](https://osintframework.com/)* - хаб с популярнейшими инструментами осинта в любой сфере
- *[Awesome OSINT](https://github.com/jivoi/awesome-osint)* - хаб инструментов, статей, кейсов и ресурсов по осинту


## Практика
#### Поиск доменных имен и поддоменов
Как уже говорилось, поиск делится на *активные* и *пассивные* методы. Разберем чуть подробнее:
##### **Методы активного поиска:**
1. Опрашивание DNS сервиса на известные ему записи, раскрывающие доменные имена, связанные с доменом 2 уровня. Выполняются запросы к DNS записям, подробнее в таблице:

| Тип записи | Назначение                                                                  | Пример значения                                                          |
| ---------- | --------------------------------------------------------------------------- | ------------------------------------------------------------------------ |
| **A**      | IPv4-адрес хоста                                                            | 93.184.216.34                                                            |
| **AAAA**   | IPv6-адрес хоста                                                            | 2606:2800:220:1:248:1893:25c8:1946                                       |
| **CNAME**  | Каноническое имя (алиас на другой домен)                                    | www → example.com                                                        |
| **MX**     | Почтовый сервер (с приоритетом)                                             | 10 mail.example.com                                                      |
| **NS**     | Авторитетные DNS-серверы для домена                                         | ns1.example.com                                                          |
| **TXT**    | Текстовые записи (SPF, DKIM, DMARC, верификация)                            | "v=spf1 include:_spf.google.com ~all"                                    |
| **SRV**    | Указывает сервисы (порт, протокол, приоритет)                               | _sip._tcp.example.com → 10 60 5060 sipserver.example.com                 |
| **PTR**    | Обратное разрешение IP → домен                                              | 34.216.184.93.in-addr.arpa → example.com                                 |
| **SOA**    | Start of Authority — информация о зоне (сервер, email администратора и др.) | ns1.example.com hostmaster.example.com 2025092101 7200 3600 1209600 3600 |
| **CAA**    | Ограничение, какие CA могут выпускать SSL-сертификаты                       | 0 issue "letsencrypt.org"                                                |
| **SPF**    | Механизм отправки почты (часто в TXT)                                       | "v=spf1 mx -all"                                                         |
| **DNSKEY** | Публичный ключ для DNSSEC                                                   | (ключ в base64)                                                          |
| **DS**     | Delegation Signer — связывает ключи родительской и дочерней зоны (DNSSEC)   | 12345 8 2 49FD46E6...                                                    |
| **RRSIG**  | Цифровая подпись записи (DNSSEC)                                            | (подпись)                                                                |
| **NSEC**   | Указывает на отсутствие записи (исп. в DNSSEC)                              | next.example.com A AAAA RRSIG NSEC                                       |
| **NSEC3**  | Более защищённый вариант NSEC (хэшированные имена)                          | (хэш → next record)                                                      |
| **NAPTR**  | Правила преобразования имён (VoIP, ENUM)                                    | 100 50 "s" "SIP+D2U" "" _sip._udp.example.com                            |
| **LOC**    | Геолокация хоста (широта, долгота, высота)                                  | 52 22 23.000 N 4 53 32.000 E 1m                                          |
| **HINFO**  | Информация об ОС и железе (устар.)                                          | "Intel x86" "Windows"                                                    |
| **RP**     | Responsible Person — email администратора                                   | admin.example.com                                                        |
| **AFSDB**  | Серверы AFS (устар., редко используется)                                    | afsdb1.example.com                                                       |
| **CERT**   | Сертификаты или ключи (PKIX, PGP и др.)                                     | (base64 блок)                                                            |
| **SSHFP**  | Отпечатки SSH-ключей                                                        | 1 1 123456789abcdef...                                                   |
| **TLSA**   | Используется с DANE для TLS (прикрепляет сертификаты к домену)              | 3 1 1 abcd1234...                                                        |
| **SVCB**   | Service Binding — новый тип для указания сервисов                           | 1 . alpn=h2                                                              |
| **HTTPS**  | Специальный вариант SVCB для HTTPS                                          | 1 . alpn=h3                                                              |
| **URI**    | Указывает на URI-ресурс                                                     | 10 1 "[https://example.com/service](https://example.com/service)"        |
2. Перебор доменных имен на DNS сервисе компании при помощи словарей или правил мутации. В данном случае подойдут утилиты *subfinder* или *amass*
3. *Выполнение AXFR запроса*. AXFR запрос, или Zone transfer - процесс передачи копии базы данных с DNS-зоной от главного сервера к вторичному. При продуманной безопасности трансфер зоны ограничен только для определенных доверенных серверов, но если конфигурации у серверов цели неправильная или ненастроена - трансферы разрешены любому, кто их просит.
   ```sh
   nslookup -q=AXFR example.com 8.8.8.8
   ```
   Однако, зачастую это не работает, но пробовать стоит.
***Инструментарий:***
- amass
- Sublist3r
- assetfinder
- subfinder
- nslookup
##### **Методы пассивного поиска:**
Методы пассивного поиска сводятся к использованию служб, которые произвели активный поиск за нас или агрегировали уже известную информацию.
***Инструментарий:***
- dnsdumpster.com (Отчасти бесплатно)
- shodan.io
- censys.io (Платно)
- crt.sh
- pentest-tools.com (Платно)

#### Сканеры сети
**Сетевой сканер** - утилита для сканирования компьютерных сетей и обнаружения *устройств*, *портов* и *служб*, работающих на этих устройствах.
***Инструментарий:***
- *Nmap* - консольная база, есть GUI - *Zenmap*
  [[Nmap для чайников]]
- *Masscan* - альтернатива, меньше аддонов, но в разы быстрее работает
##### **А как работает сканирование портов?**
Данное действо строится на работе протоколов транспортного уровня, именно на этом уровне идет распределение трафика между приложениями на сетевые порты. 
Рассмотрим работу сканирования на основе протоколов TCP и UDP:

**Протокол TCP**
При его использовании устанавливается соединение, гарантирующее доставку пакетов, и происходит контролирование порядка отправляемых пакетов. Это происходит через механизм трехэтапного рукопожатия:
1. Клиент отправляет пакет с флагом SYN, этому пакету присваивается произвольный *порядковый номер* (*sequence number*) в интервале от 1 до 232, относительно которого будет вестись отсчет последовательности пакетов в соединении.
2. Сервер получает запрос и отправляет ответный пакет с одновременно установленными флагами SYN+ACK, при этом записывает в поле *номер подтверждения* (*acknowledgement number*), полученный порядковый номер + 1 (что подтверждает получение первого пакета), а также устанавливает свой порядковый номер, который как и в SYN-пакете, выбирается произвольно.
3. После получения клиентом пакета с флагами SYN+ACK соединение считается установленным, клиент отправляет в ответ пакет с флагом ACK, обновленными номерами последовательности и не содержащий полезной нагрузки.
*Какие можно из этого сделать выводы?*
- Если сервис на открытом порту *отвечает пакетом SYN+ACK*, то он *существует* и *открыт*.
- Если сервис *не отвечает* или *возвращает пакет, отличный от пакета с флагами SYN+ACK*, то порт *фильтруется* или *закрыт*.

**Протокол UDP**
При его использовании не устанавливается соединение, открыт или закрыт порт - определяем с помощью ICMP ответов: если отсылается *ответный UDP-пакет* - *порт открыт*, если в ответ получаем *ICMP:port-unreachable* - *порт закрыт*, в случае *отсутствия ответа* - *порт открыт|фильтруется*.
##### **Алгоритм сканирования портов**
1. Получаем IP-адрес сетевого узла цели.
2. Определяемся какие порты какого протокола сканируем: *TCP* или *UDP*.
3. Если выбор пал на TCP, то необходимо выбрать методику сканирования:
   - *TCP-SYN* сканирование (*-sS*) - метод, при котором устанавливается неполное TCP соединение. Из плюсов: быстрое сканирование, относительная скрытность. Из минусов: нет гарантии достоверности информации (порт может блокировать соединение).
   - *Полное TCP* сканирование с использованием системного вызова *connect* (*-sT*) - метод, при котором устанавливается полное соединение. Из плюсов: гарантирует полноценную информацию. Из минусов: медленное сканирование.
А теперь можно и провести сканирование:
```shell
nmap -sS <example.com> - TCP-SYN сканирование узла
nmap -sT <example.com> - полное TCP сканирование узла
nmap -sU <example.com> - UDP сканирование узла
```
   